<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//uporm.github.io//DTD Mapper 1//EN" "https://uporm.github.io/dtd/uorm-1-mapper.dtd">
<mapper namespace="app">

    <sql id="cols">
        id, tenant_id, workspace_id, folder_id, app_type, name, description, create_at, update_at
    </sql>

    <!--
        查询应用列表
        支持按folder_id和name过滤
        关联app_tag表获取标签ID列表（逗号分隔）
    -->
    <select id="list">
        select
        a.id, a.tenant_id, a.workspace_id, a.folder_id, a.app_type, a.name, a.description, a.create_at, a.update_at,
        (
            SELECT GROUP_CONCAT(at.tag_id)
            FROM app_tag at
            WHERE at.app_id = a.id
            AND at.tenant_id = a.tenant_id
            AND at.workspace_id = a.workspace_id
        ) as tag_ids_str
        from app a
        where a.tenant_id = #{tenantId}
        and a.workspace_id = #{workspaceId}
        <if test="query.folderId != null">
            and a.folder_id = #{query.folderId}
        </if>
        <if test="query.name != null and query.name != ''">
            and a.name like concat('%', #{query.name}, '%')
        </if>
        order by a.create_at desc
    </select>

    <select id="getById">
        select
        a.id, a.tenant_id, a.workspace_id, a.folder_id, a.app_type, a.name, a.description, a.create_at, a.update_at,
        (
            SELECT GROUP_CONCAT(at.tag_id)
            FROM app_tag at
            WHERE at.app_id = a.id
            AND at.tenant_id = a.tenant_id
            AND at.workspace_id = a.workspace_id
        ) as tag_ids_str
        from app a
        where a.id = #{id}
        and a.tenant_id = #{tenantId}
        and a.workspace_id = #{workspaceId}
    </select>

    <insert id="insert">
        insert into app (id, tenant_id, workspace_id, folder_id, app_type, name, description, create_at, update_at)
        values (#{id}, #{tenantId}, #{workspaceId}, #{folderId}, #{appType}, #{name}, #{description}, now(), now())
    </insert>

    <update id="update">
        update app
        set name = #{name},
        description = #{description},
        update_at = now()
        where id = #{id}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
    </update>

    <delete id="delete">
        delete from app
        where id = #{id}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
    </delete>

    <delete id="deleteByFolderId">
        delete from app
        where folder_id = #{folderId}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
    </delete>

    <insert id="batchInsertAppTags">
        insert into app_tag (tenant_id, workspace_id, app_id, tag_id, create_at)
        values
        <foreach item="tagId" collection="tagIds" separator=",">
            (#{tenantId}, #{workspaceId}, #{appId}, #{tagId}, now())
        </foreach>
    </insert>

    <delete id="deleteAppTag">
        delete from app_tag
        where app_id = #{appId}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
    </delete>

    <delete id="deleteAppTagByTagId">
        delete from app_tag
        where tag_id = #{tagId}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
    </delete>

    <select id="listAppTagsByAppIds">
        select id, tenant_id, workspace_id, app_id, tag_id
        from app_tag
        where tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
        and app_id in
        <foreach item="appId" collection="appIds" open="(" separator="," close=")">
            #{appId}
        </foreach>
    </select>

    <select id="getDraft">
        select id, tenant_id, workspace_id, app_id, spec
        from app_draft
        where app_id = #{appId}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
    </select>

    <insert id="insertOrUpdateDraft">
        insert into app_draft (id, tenant_id, workspace_id, app_id, spec, create_at, update_at)
        values (#{id}, #{tenantId}, #{workspaceId}, #{appId}, #{spec}, now(), now())
        on duplicate key update
        spec = VALUES(spec),
        update_at = now()
    </insert>

    <delete id="deleteDraft">
        delete from app_draft
        where app_id = #{appId}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
    </delete>

    <update id="cancelLatest">
        update app_version
        set is_latest = false
        where app_id = #{appId}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
        and is_latest = true
    </update>

    <insert id="insertVersion">
        insert into app_version (id, tenant_id, workspace_id, app_id, version, major, minor, patch, pre_release, description, is_latest, create_at)
        values (#{id}, #{tenantId}, #{workspaceId}, #{appId}, #{version},
                #{major}, #{minor}, #{patch}, #{preRelease}, #{description}, #{isLatest}, now())
    </insert>

    <insert id="insertVersionSpec">
        insert into app_version_spec (id, tenant_id, workspace_id, app_version_id, spec, create_at)
        values (#{id}, #{tenantId}, #{workspaceId}, #{appVersionId}, #{spec}, now())
    </insert>

    <delete id="deleteVersions">
        delete from app_version
        where app_id = #{appId}
        and tenant_id = #{tenantId}
        and workspace_id = #{workspaceId}
    </delete>

    <delete id="deleteVersionSpecs">
        delete from app_version_spec
        where app_version_id in (
            select id
            from app_version
            where app_id = #{appId}
            and tenant_id = #{tenantId}
            and workspace_id = #{workspaceId}
        )
    </delete>
</mapper>
